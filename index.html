<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Horarios</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Flatpickr para selector de fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            padding-bottom: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            padding: 15px 20px;
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .date-navigation {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .badge-success {
            background-color: var(--success-color);
        }
        
        .badge-warning {
            background-color: var(--warning-color);
        }
        
        .section-title {
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            margin: 25px 0 15px;
            font-weight: 600;
        }
        
        .form-check-input:checked {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .form-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .table-responsive {
            border-radius: 8px;
        }
        
        .action-buttons .btn {
            margin-right: 5px;
        }
        
        .total-amount {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .date-display {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .date-display:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        /* Mejoras para móviles */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .modal-dialog {
                margin: 10px;
            }
            
            .date-navigation .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .date-navigation h3 {
                font-size: 1.1rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }
        }
        
        /* Estilo para el calendario */
        .flatpickr-calendar {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .flatpickr-day.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .flatpickr-day.today {
            border-color: var(--primary-color);
        }
        
        .calendar-container {
            position: relative;
        }
        
        .calendar-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">Control de Horarios</h1>
                    <p class="mb-0">Gestión de horarios de empleados</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <span id="current-date" class="h5 mb-0"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container my-4">
        <!-- Date Navigation -->
        <div class="date-navigation">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center flex-wrap">
                        <button id="prev-week" class="btn btn-outline-primary me-2 mb-2">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="week-display" class="mb-0 me-3 mb-2 date-display">Semana del 03/11/2025 al 09/11/2025</h3>
                        <button id="next-week" class="btn btn-outline-primary me-3 mb-2">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="calendar-container mb-2">
                            <input type="text" id="date-picker" class="form-control" placeholder="Seleccionar fecha" style="padding-right: 40px;">
                            <i class="fas fa-calendar-alt calendar-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <button id="today-btn" class="btn btn-outline-secondary mb-2">
                        <i class="fas fa-calendar-day me-2"></i>Hoy
                    </button>
                </div>
            </div>
        </div>

        <!-- Sections -->
        <div id="sections-container">
            <!-- Turnos Section -->
            <div class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title">Horarios Trabajados por Turnos</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addShiftModal">
                        <i class="fas fa-plus me-2"></i>AGREGAR
                    </button>
                </div>
                
                <div id="shift-cards-container">
                    <!-- Las tarjetas de turnos se generarán dinámicamente aquí -->
                </div>
            </div>

            <!-- Horas Section -->
            <div class="section mt-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title">Horarios Trabajados por Horas</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHoursModal">
                        <i class="fas fa-plus me-2"></i>AGREGAR
                    </button>
                </div>
                
                <div id="hours-cards-container">
                    <!-- Las tarjetas de horas se generarán dinámicamente aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar turnos -->
    <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addShiftModalLabel">Agregar Horario por Turnos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="shift-form">
                        <div class="mb-3">
                            <label for="shift-project" class="form-label">Proyecto/Actividad</label>
                            <input type="text" class="form-control" id="shift-project" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="shift-employee" class="form-label">Empleado</label>
                            <input type="text" class="form-control" id="shift-employee" required>
                        </div>
                        
                        <div class="form-section">
                            <h6 class="mb-3">Días trabajados (cada día marcado equivale a ₡15,000)</h6>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-lunes">
                                        <label class="form-check-label" for="shift-lunes">
                                            Lunes
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-martes">
                                        <label class="form-check-label" for="shift-martes">
                                            Martes
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-miercoles">
                                        <label class="form-check-label" for="shift-miercoles">
                                            Miércoles
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-jueves">
                                        <label class="form-check-label" for="shift-jueves">
                                            Jueves
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-viernes">
                                        <label class="form-check-label" for="shift-viernes">
                                            Viernes
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-sabado">
                                        <label class="form-check-label" for="shift-sabado">
                                            Sábado
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input day-checkbox" type="checkbox" id="shift-domingo">
                                        <label class="form-check-label" for="shift-domingo">
                                            Domingo
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total estimado: <span id="shift-total" class="total-amount">₡0</span></label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-shift">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar horas -->
    <div class="modal fade" id="addHoursModal" tabindex="-1" aria-labelledby="addHoursModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addHoursModalLabel">Agregar Horario por Horas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="hours-form">
                        <div class="mb-3">
                            <label for="hours-project" class="form-label">Proyecto/Actividad</label>
                            <input type="text" class="form-control" id="hours-project" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="hours-employee" class="form-label">Empleado</label>
                            <input type="text" class="form-control" id="hours-employee" required>
                        </div>
                        
                        <div class="form-section">
                            <h6 class="mb-3">Horas trabajadas (cada hora equivale a ₡2,000)</h6>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label for="hours-lunes" class="form-label">Lunes</label>
                                    <input type="number" class="form-control hours-input" id="hours-lunes" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-martes" class="form-label">Martes</label>
                                    <input type="number" class="form-control hours-input" id="hours-martes" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-miercoles" class="form-label">Miércoles</label>
                                    <input type="number" class="form-control hours-input" id="hours-miercoles" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-jueves" class="form-label">Jueves</label>
                                    <input type="number" class="form-control hours-input" id="hours-jueves" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-viernes" class="form-label">Viernes</label>
                                    <input type="number" class="form-control hours-input" id="hours-viernes" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-sabado" class="form-label">Sábado</label>
                                    <input type="number" class="form-control hours-input" id="hours-sabado" min="0" value="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="hours-domingo" class="form-label">Domingo</label>
                                    <input type="number" class="form-control hours-input" id="hours-domingo" min="0" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total estimado: <span id="hours-total" class="total-amount">₡0</span></label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-hours">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea eliminar este registro? Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr para selector de fechas -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        // Datos de ejemplo
        let shiftData = JSON.parse(localStorage.getItem('shiftData')) || [
            {
                id: 1,
                project: "Activación Banco Promerica",
                employee: "Jefferson",
                days: [true, true, true, true, false, true, true],
                total: 75000,
                week: "03/11/2025 al 09/11/2025"
            },
            {
                id: 2,
                project: "Activación Banco Promerica",
                employee: "Bryan",
                days: [false, true, false, false, false, true, true],
                total: 45000,
                week: "03/11/2025 al 09/11/2025"
            }
        ];

        let hoursData = JSON.parse(localStorage.getItem('hoursData')) || [
            {
                id: 1,
                project: "Activación Banco Promerica",
                employee: "Jefferson",
                hours: [4, 0, 3, 0, 0, 2, 0],
                totalHours: 9,
                total: 18000,
                week: "24/11/2025 al 30/11/2025"
            },
            {
                id: 2,
                project: "Activación Banco Promerica",
                employee: "Bryan",
                hours: [0, 1, 0, 0, 3, 0, 0],
                totalHours: 4,
                total: 8000,
                week: "24/11/2025 al 30/11/2025"
            }
        ];

        // Variables globales
        let currentWeek = new Date(2025, 10, 3); // 3 de noviembre de 2025
        let editingShiftId = null;
        let editingHoursId = null;
        let itemToDelete = null;
        let deleteType = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos guardados
            loadFromLocalStorage();
            
            // Inicializar el selector de fecha
            initDatePicker();
            
            updateDateDisplay();
            renderShiftCards();
            renderHoursCards();
            
            // Event listeners para navegación de fechas
            document.getElementById('prev-week').addEventListener('click', prevWeek);
            document.getElementById('next-week').addEventListener('click', nextWeek);
            document.getElementById('today-btn').addEventListener('click', goToToday);
            document.getElementById('week-display').addEventListener('click', function() {
                document.getElementById('date-picker').click();
            });
            
            // Event listeners para formularios
            document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', calculateShiftTotal);
            });
            
            document.querySelectorAll('.hours-input').forEach(input => {
                input.addEventListener('input', calculateHoursTotal);
            });
            
            document.getElementById('save-shift').addEventListener('click', saveShift);
            document.getElementById('save-hours').addEventListener('click', saveHours);
            
            // Event listener para confirmación de eliminación
            document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
            
            // Inicializar cálculos
            calculateShiftTotal();
            calculateHoursTotal();
        });

        // Funciones de navegación de fechas
        function prevWeek() {
            currentWeek.setDate(currentWeek.getDate() - 7);
            updateDateDisplay();
            updateTablesByWeek();
        }

        function nextWeek() {
            currentWeek.setDate(currentWeek.getDate() + 7);
            updateDateDisplay();
            updateTablesByWeek();
        }

        function goToToday() {
            currentWeek = getStartOfWeek(new Date());
            updateDateDisplay();
            updateTablesByWeek();
        }

        function initDatePicker() {
            flatpickr("#date-picker", {
                locale: "es",
                dateFormat: "d/m/Y",
                defaultDate: currentWeek,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        currentWeek = getStartOfWeek(selectedDates[0]);
                        updateDateDisplay();
                        updateTablesByWeek();
                    }
                }
            });
        }

        function getStartOfWeek(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day + (day === 0 ? -6 : 1); // Ajuste para que la semana empiece en lunes
            start.setDate(diff);
            return start;
        }

        function updateDateDisplay() {
            const startOfWeek = new Date(currentWeek);
            const endOfWeek = new Date(currentWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const startStr = startOfWeek.toLocaleDateString('es-ES', options);
            const endStr = endOfWeek.toLocaleDateString('es-ES', options);
            
            document.getElementById('week-display').textContent = `Semana del ${startStr} al ${endStr}`;
            
            // Actualizar la fecha actual en el header
            const today = new Date();
            document.getElementById('current-date').textContent = today.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function updateTablesByWeek() {
            renderShiftCards();
            renderHoursCards();
        }

        // Funciones para la tabla de turnos
        function renderShiftCards() {
            const container = document.getElementById('shift-cards-container');
            container.innerHTML = '';
            
            // Filtrar datos por semana actual
            const currentWeekString = getCurrentWeekString();
            const weekData = shiftData.filter(item => item.week === currentWeekString);
            
            // Agrupar por proyecto
            const projects = {};
            weekData.forEach(item => {
                if (!projects[item.project]) {
                    projects[item.project] = [];
                }
                projects[item.project].push(item);
            });
            
            // Crear tarjetas para cada proyecto
            for (const project in projects) {
                const card = document.createElement('div');
                card.className = 'card mb-4';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                cardHeader.innerHTML = `
                    <span>${project}</span>
                    <span class="badge bg-primary">${currentWeekString}</span>
                `;
                card.appendChild(cardHeader);
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-0';
                
                const table = document.createElement('div');
                table.className = 'table-responsive';
                table.innerHTML = `
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>L</th>
                                <th>M</th>
                                <th>K</th>
                                <th>J</th>
                                <th>V</th>
                                <th>S</th>
                                <th>D</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="shift-table-${project.replace(/\s+/g, '-')}">
                        </tbody>
                    </table>
                `;
                
                cardBody.appendChild(table);
                card.appendChild(cardBody);
                container.appendChild(card);
                
                // Llenar la tabla
                const tbody = document.getElementById(`shift-table-${project.replace(/\s+/g, '-')}`);
                projects[project].forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Nombre
                    const nameCell = document.createElement('td');
                    nameCell.textContent = item.employee;
                    row.appendChild(nameCell);
                    
                    // Días
                    item.days.forEach(day => {
                        const dayCell = document.createElement('td');
                        if (day) {
                            dayCell.innerHTML = '<i class="fas fa-check text-success"></i>';
                        } else {
                            dayCell.innerHTML = '<i class="fas fa-times text-danger"></i>';
                        }
                        row.appendChild(dayCell);
                    });
                    
                    // Total
                    const totalCell = document.createElement('td');
                    totalCell.textContent = `₡${item.total.toLocaleString('es-CR')}`;
                    row.appendChild(totalCell);
                    
                    // Acciones
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'action-buttons';
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-outline-primary edit-shift" data-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-shift" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            // Agregar event listeners para los botones de editar y eliminar
            document.querySelectorAll('.edit-shift').forEach(button => {
                button.addEventListener('click', function() {
                    editShift(parseInt(this.getAttribute('data-id')));
                });
            });
            
            document.querySelectorAll('.delete-shift').forEach(button => {
                button.addEventListener('click', function() {
                    showDeleteConfirmation(parseInt(this.getAttribute('data-id')), 'shift');
                });
            });
            
            // Si no hay datos, mostrar mensaje
            if (Object.keys(projects).length === 0) {
                container.innerHTML = '<div class="text-center py-4">No hay horarios registrados para esta semana</div>';
            }
        }

        function calculateShiftTotal() {
            const checkboxes = document.querySelectorAll('.day-checkbox');
            let checkedCount = 0;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) checkedCount++;
            });
            
            const total = checkedCount * 15000;
            document.getElementById('shift-total').textContent = `₡${total.toLocaleString('es-CR')}`;
        }

        function saveShift() {
            const project = document.getElementById('shift-project').value;
            const employee = document.getElementById('shift-employee').value;
            
            const days = [
                document.getElementById('shift-lunes').checked,
                document.getElementById('shift-martes').checked,
                document.getElementById('shift-miercoles').checked,
                document.getElementById('shift-jueves').checked,
                document.getElementById('shift-viernes').checked,
                document.getElementById('shift-sabado').checked,
                document.getElementById('shift-domingo').checked
            ];
            
            const checkedDays = days.filter(day => day).length;
            const total = checkedDays * 15000;
            
            if (editingShiftId) {
                // Editar registro existente
                const index = shiftData.findIndex(item => item.id === editingShiftId);
                if (index !== -1) {
                    shiftData[index] = {
                        ...shiftData[index],
                        project,
                        employee,
                        days,
                        total
                    };
                }
                editingShiftId = null;
            } else {
                // Crear nuevo registro
                const newId = shiftData.length > 0 ? Math.max(...shiftData.map(item => item.id)) + 1 : 1;
                shiftData.push({
                    id: newId,
                    project,
                    employee,
                    days,
                    total,
                    week: getCurrentWeekString()
                });
            }
            
            // Guardar en localStorage
            saveToLocalStorage();
            
            // Cerrar modal y actualizar tabla
            bootstrap.Modal.getInstance(document.getElementById('addShiftModal')).hide();
            resetShiftForm();
            renderShiftCards();
        }

        function editShift(id) {
            const item = shiftData.find(item => item.id === id);
            if (!item) return;
            
            editingShiftId = id;
            
            // Llenar el formulario con los datos existentes
            document.getElementById('shift-project').value = item.project;
            document.getElementById('shift-employee').value = item.employee;
            
            document.getElementById('shift-lunes').checked = item.days[0];
            document.getElementById('shift-martes').checked = item.days[1];
            document.getElementById('shift-miercoles').checked = item.days[2];
            document.getElementById('shift-jueves').checked = item.days[3];
            document.getElementById('shift-viernes').checked = item.days[4];
            document.getElementById('shift-sabado').checked = item.days[5];
            document.getElementById('shift-domingo').checked = item.days[6];
            
            calculateShiftTotal();
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('addShiftModal'));
            modal.show();
        }

        function showDeleteConfirmation(id, type) {
            itemToDelete = id;
            deleteType = type;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        function confirmDelete() {
            if (deleteType === 'shift') {
                shiftData = shiftData.filter(item => item.id !== itemToDelete);
                renderShiftCards();
            } else if (deleteType === 'hours') {
                hoursData = hoursData.filter(item => item.id !== itemToDelete);
                renderHoursCards();
            }
            
            // Guardar en localStorage
            saveToLocalStorage();
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
            
            // Resetear variables
            itemToDelete = null;
            deleteType = null;
        }

        function resetShiftForm() {
            document.getElementById('shift-form').reset();
            editingShiftId = null;
            calculateShiftTotal();
        }

        // Funciones para la tabla de horas
        function renderHoursCards() {
            const container = document.getElementById('hours-cards-container');
            container.innerHTML = '';
            
            // Filtrar datos por semana actual
            const currentWeekString = getCurrentWeekString();
            const weekData = hoursData.filter(item => item.week === currentWeekString);
            
            // Agrupar por proyecto
            const projects = {};
            weekData.forEach(item => {
                if (!projects[item.project]) {
                    projects[item.project] = [];
                }
                projects[item.project].push(item);
            });
            
            // Crear tarjetas para cada proyecto
            for (const project in projects) {
                const card = document.createElement('div');
                card.className = 'card mb-4';
                
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                cardHeader.innerHTML = `
                    <span>${project}</span>
                    <span class="badge bg-primary">${currentWeekString}</span>
                `;
                card.appendChild(cardHeader);
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-0';
                
                const table = document.createElement('div');
                table.className = 'table-responsive';
                table.innerHTML = `
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>L</th>
                                <th>M</th>
                                <th>K</th>
                                <th>J</th>
                                <th>V</th>
                                <th>S</th>
                                <th>D</th>
                                <th>Total horas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="hours-table-${project.replace(/\s+/g, '-')}">
                        </tbody>
                    </table>
                `;
                
                cardBody.appendChild(table);
                card.appendChild(cardBody);
                container.appendChild(card);
                
                // Llenar la tabla
                const tbody = document.getElementById(`hours-table-${project.replace(/\s+/g, '-')}`);
                projects[project].forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Nombre
                    const nameCell = document.createElement('td');
                    nameCell.textContent = item.employee;
                    row.appendChild(nameCell);
                    
                    // Horas por día
                    item.hours.forEach(hours => {
                        const hourCell = document.createElement('td');
                        hourCell.textContent = hours > 0 ? hours : '';
                        row.appendChild(hourCell);
                    });
                    
                    // Total horas
                    const totalHoursCell = document.createElement('td');
                    totalHoursCell.textContent = item.totalHours;
                    row.appendChild(totalHoursCell);
                    
                    // Acciones
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'action-buttons';
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-outline-primary edit-hours" data-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-hours" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            // Agregar event listeners para los botones de editar y eliminar
            document.querySelectorAll('.edit-hours').forEach(button => {
                button.addEventListener('click', function() {
                    editHours(parseInt(this.getAttribute('data-id')));
                });
            });
            
            document.querySelectorAll('.delete-hours').forEach(button => {
                button.addEventListener('click', function() {
                    showDeleteConfirmation(parseInt(this.getAttribute('data-id')), 'hours');
                });
            });
            
            // Si no hay datos, mostrar mensaje
            if (Object.keys(projects).length === 0) {
                container.innerHTML = '<div class="text-center py-4">No hay horarios registrados para esta semana</div>';
            }
        }

        function calculateHoursTotal() {
            const inputs = document.querySelectorAll('.hours-input');
            let totalHours = 0;
            
            inputs.forEach(input => {
                totalHours += parseInt(input.value) || 0;
            });
            
            const total = totalHours * 2000;
            document.getElementById('hours-total').textContent = `₡${total.toLocaleString('es-CR')}`;
        }

        function saveHours() {
            const project = document.getElementById('hours-project').value;
            const employee = document.getElementById('hours-employee').value;
            
            const hours = [
                parseInt(document.getElementById('hours-lunes').value) || 0,
                parseInt(document.getElementById('hours-martes').value) || 0,
                parseInt(document.getElementById('hours-miercoles').value) || 0,
                parseInt(document.getElementById('hours-jueves').value) || 0,
                parseInt(document.getElementById('hours-viernes').value) || 0,
                parseInt(document.getElementById('hours-sabado').value) || 0,
                parseInt(document.getElementById('hours-domingo').value) || 0
            ];
            
            const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
            const total = totalHours * 2000;
            
            if (editingHoursId) {
                // Editar registro existente
                const index = hoursData.findIndex(item => item.id === editingHoursId);
                if (index !== -1) {
                    hoursData[index] = {
                        ...hoursData[index],
                        project,
                        employee,
                        hours,
                        totalHours,
                        total
                    };
                }
                editingHoursId = null;
            } else {
                // Crear nuevo registro
                const newId = hoursData.length > 0 ? Math.max(...hoursData.map(item => item.id)) + 1 : 1;
                hoursData.push({
                    id: newId,
                    project,
                    employee,
                    hours,
                    totalHours,
                    total,
                    week: getCurrentWeekString()
                });
            }
            
            // Guardar en localStorage
            saveToLocalStorage();
            
            // Cerrar modal y actualizar tabla
            bootstrap.Modal.getInstance(document.getElementById('addHoursModal')).hide();
            resetHoursForm();
            renderHoursCards();
        }

        function editHours(id) {
            const item = hoursData.find(item => item.id === id);
            if (!item) return;
            
            editingHoursId = id;
            
            // Llenar el formulario con los datos existentes
            document.getElementById('hours-project').value = item.project;
            document.getElementById('hours-employee').value = item.employee;
            
            document.getElementById('hours-lunes').value = item.hours[0];
            document.getElementById('hours-martes').value = item.hours[1];
            document.getElementById('hours-miercoles').value = item.hours[2];
            document.getElementById('hours-jueves').value = item.hours[3];
            document.getElementById('hours-viernes').value = item.hours[4];
            document.getElementById('hours-sabado').value = item.hours[5];
            document.getElementById('hours-domingo').value = item.hours[6];
            
            calculateHoursTotal();
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('addHoursModal'));
            modal.show();
        }

        function resetHoursForm() {
            document.getElementById('hours-form').reset();
            editingHoursId = null;
            calculateHoursTotal();
        }

        // Función auxiliar para obtener la cadena de la semana actual
        function getCurrentWeekString() {
            const startOfWeek = new Date(currentWeek);
            const endOfWeek = new Date(currentWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const startStr = startOfWeek.toLocaleDateString('es-ES', options);
            const endStr = endOfWeek.toLocaleDateString('es-ES', options);
            
            return `${startStr} al ${endStr}`;
        }

        // Funciones para localStorage
        function saveToLocalStorage() {
            localStorage.setItem('shiftData', JSON.stringify(shiftData));
            localStorage.setItem('hoursData', JSON.stringify(hoursData));
        }

        function loadFromLocalStorage() {
            const savedShiftData = localStorage.getItem('shiftData');
            const savedHoursData = localStorage.getItem('hoursData');
            
            if (savedShiftData) {
                shiftData = JSON.parse(savedShiftData);
            }
            
            if (savedHoursData) {
                hoursData = JSON.parse(savedHoursData);
            }
        }
    </script>
</body>
</html>